<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Theo 的小花园</title>
  <style>
    :root { color-scheme: light; }
    body{
      margin:0; min-height:100svh; display:grid; place-items:center;
      font-family:-apple-system,BlinkMacSystemFont,"PingFang SC","Segoe UI",Roboto,Helvetica,Arial,sans-serif;
      background:
        radial-gradient(1200px 600px at 15% 18%, #ffe8f1, transparent 60%),
        radial-gradient(1000px 600px at 85% 25%, #e7f3ff, transparent 55%),
        radial-gradient(900px 700px at 50% 92%, #fff6d6, transparent 60%),
        #fff;
      /* Reduce accidental double-tap zoom on interactive elements */
      touch-action: manipulation;
    }
    .card{
      width:min(860px, calc(100% - 32px));
      border-radius:22px;
      background: rgba(255,255,255,0.78);
      border:1px solid rgba(0,0,0,0.06);
      box-shadow:0 24px 70px rgba(0,0,0,0.10);
      backdrop-filter: blur(10px);
      padding:26px;
    }
    .title{font-size:30px; font-weight:900; color:rgba(0,0,0,0.82)}
    .sub{margin-top:6px; font-size:14px; color:rgba(0,0,0,0.55); line-height:1.6}
    .bubble{
      margin-top:18px; padding:18px 16px; border-radius:18px;
      background: linear-gradient(135deg, rgba(255,205,226,0.55), rgba(200,233,255,0.55));
      border:1px solid rgba(0,0,0,0.06);
    }
    .bubbleText{font-size:18px; line-height:1.75; color:rgba(0,0,0,0.75)}
    .sign{margin-top:12px; font-size:13px; color:rgba(0,0,0,0.55)}

    /* check-in calendar */
    .calWrap{margin-top:14px; padding:12px; border-radius:18px; background: rgba(255,255,255,0.55); border:1px solid rgba(0,0,0,0.06)}
    .calHead{display:flex; align-items:center; justify-content:space-between; gap:10px;}
    .calTitle{font-weight:900; color:rgba(0,0,0,0.78)}
    .calWeek{margin-top:10px; display:grid; grid-template-columns: repeat(7, minmax(0,1fr)); gap:8px;}
    .calWeek div{font-size:12px; color:rgba(0,0,0,0.42); text-align:center;}
    .calGrid{margin-top:8px; display:grid; grid-template-columns: repeat(7, minmax(0,1fr)); gap:8px;}
    .calCell{border-radius:14px; border:1px solid rgba(0,0,0,0.06); background: rgba(255,255,255,0.64); padding:10px 8px; min-height:44px; position:relative;}
    .calCell.dim{opacity:0.4;}
    .calCell.signed{background: linear-gradient(135deg, rgba(31,102,227,0.18), rgba(255,143,194,0.12)); border-color: rgba(31,102,227,0.16)}
    .calNum{font-weight:900; color:rgba(0,0,0,0.72)}
    .calDot{position:absolute; right:10px; bottom:10px; width:8px; height:8px; border-radius:999px; background: rgba(31,102,227,0.65)}
    .btns{margin-top:12px; display:flex; gap:10px; flex-wrap:wrap}
    .btn{
      border:0; border-radius:999px; padding:10px 14px; font-size:14px; cursor:pointer;
      background: rgba(255,255,255,0.8);
      box-shadow: 0 10px 24px rgba(0,0,0,0.08);
      touch-action: manipulation;
      -webkit-tap-highlight-color: transparent;
      user-select: none;
    }
    .btn.primary{background: linear-gradient(135deg, #ff8fc2, #7cc7ff); color:#fff; font-weight:800;}
    .btn:hover{transform: translateY(-1px)}
    .stats{margin-top:14px; display:grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap:10px;}
    .stat{padding:14px; border-radius:16px; background: rgba(255,255,255,0.70); border:1px solid rgba(0,0,0,0.06)}
    .statLabel{font-size:12px; color:rgba(0,0,0,0.55)}
    .statValue{margin-top:4px; font-size:22px; font-weight:900; color:rgba(0,0,0,0.78)}
    .game{margin-top:16px; padding:16px; border-radius:18px; border:1px solid rgba(0,0,0,0.06); background: rgba(255,255,255,0.72)}
    .gameTitle{font-weight:900; color:rgba(0,0,0,0.78)}
    .gameDesc{margin-top:4px; font-size:13px; color:rgba(0,0,0,0.55)}
    .board{position:relative; margin-top:12px; height:220px; border-radius:18px; overflow:hidden;
      background: radial-gradient(700px 260px at 30% 30%, rgba(255,205,226,0.50), transparent 60%),
                  radial-gradient(700px 260px at 75% 40%, rgba(200,233,255,0.50), transparent 60%),
                  rgba(255,255,255,0.55);
      border: 1px dashed rgba(0,0,0,0.12);
    }
    .hint{
      position:absolute;
      left:0;
      right:0;
      bottom:10px;
      display:grid;
      place-items:center;
      font-size:13px;
      color:rgba(0,0,0,0.45);
      pointer-events:none;
      padding:0 12px;
      text-align:center;
    }

    /* charge game */
    .chargeStage{position:absolute; inset:10px 10px 40px 10px; display:grid; place-items:center;}
    .compareWrap{height:100%; width:100%; border-radius:18px; border:1px solid rgba(0,0,0,0.06); background: rgba(255,255,255,0.55);
      display:grid; place-items:center; position:relative; overflow:hidden;}
    .targetLabel{position:absolute; top:10px; left:12px; font-size:12px; color: rgba(0,0,0,0.45)}
    .yourLabel{position:absolute; top:10px; right:12px; font-size:12px; color: rgba(0,0,0,0.45)}

    .targetHeart{width:260px; height:260px; position:absolute; left:50%; top:50%; transform: translate(-50%,-50%); pointer-events:none;}
    .targetSvg{
      position:absolute;
      left:50%;
      top:50%;
      width:92px;
      height:92px;
      transform: translate(-50%,-50%) scale(var(--ts, 1));
      transform-origin: center;
      transition: transform 90ms linear;
      overflow: visible;
      /* ensure no “boxed” raster background */
      background: transparent;
      -webkit-backface-visibility: hidden;
      backface-visibility: hidden;
      filter: drop-shadow(0 10px 16px rgba(0,0,0,0.06));
    }

    .aimHeart{width:260px; height:260px; position:absolute; left:50%; top:50%; transform: translate(-50%,-50%);}
    .aimHeart::before{
      content:''; position:absolute; left:50%; top:50%;
      width:92px; height:92px;
      transform: translate(-50%,-50%) scale(var(--ss, 0.7));
      transition: transform 60ms linear;
      background: linear-gradient(135deg, rgba(31,102,227,1), rgba(167,219,255,1));
      filter: drop-shadow(0 10px 14px rgba(0,0,0,0.12));
      -webkit-mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 29'%3E%3Cpath d='M23.6 0c-2.8 0-5.2 1.6-6.6 3.9C15.6 1.6 13.2 0 10.4 0 4.7 0 0 4.7 0 10.4c0 9.4 16.1 18.6 16.1 18.6S32 19.8 32 10.4C32 4.7 27.3 0 23.6 0z'/%3E%3C/svg%3E");
      -webkit-mask-repeat:no-repeat; -webkit-mask-size:contain; -webkit-mask-position:center;
      mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 29'%3E%3Cpath d='M23.6 0c-2.8 0-5.2 1.6-6.6 3.9C15.6 1.6 13.2 0 10.4 0 4.7 0 0 4.7 0 10.4c0 9.4 16.1 18.6 16.1 18.6S32 19.8 32 10.4C32 4.7 27.3 0 23.6 0z'/%3E%3C/svg%3E");
      mask-repeat:no-repeat; mask-size:contain; mask-position:center;
    }
    .heart{position:absolute; bottom:-22px; width:42px; height:42px; border:0; cursor:pointer; background:transparent;
      animation-name: floatUp; animation-timing-function:ease-in; animation-fill-mode:forwards;
      touch-action: manipulation;
      -webkit-tap-highlight-color: transparent;
      user-select: none;
      z-index: 2;
    }
    .heart::after{
      content:'';
      position:absolute;
      inset:0;
      border-radius:999px;
      background: rgba(255,255,255,0.45);
      border: 1px solid rgba(0,0,0,0.06);
      box-shadow: 0 14px 26px rgba(0,0,0,0.10);
      opacity: 0.0;
      transform: scale(0.98);
      transition: opacity 120ms ease, transform 120ms ease;
    }
    .heart:active::after{ opacity: 0.9; transform: scale(1.02); }
    /* keep floatUp animation; hit effect is handled by scaling the SVG heart mask */
    .heart::before{
      content:'';
      position:absolute;
      left:50%;
      top:50%;
      width:30px;
      height:30px;
      transform: translate(-50%, -50%) scale(var(--hs, 1));
      transition: transform 140ms ease;
      background: var(--hc, #2a79ff);
      filter: drop-shadow(0 10px 14px rgba(0,0,0,0.12));
      /* SVG mask heart so color works consistently on mobile (no emoji rendering) */
      -webkit-mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 29'%3E%3Cpath d='M23.6 0c-2.8 0-5.2 1.6-6.6 3.9C15.6 1.6 13.2 0 10.4 0 4.7 0 0 4.7 0 10.4c0 9.4 16.1 18.6 16.1 18.6S32 19.8 32 10.4C32 4.7 27.3 0 23.6 0z'/%3E%3C/svg%3E");
      -webkit-mask-repeat: no-repeat;
      -webkit-mask-size: contain;
      -webkit-mask-position: center;
      mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 29'%3E%3Cpath d='M23.6 0c-2.8 0-5.2 1.6-6.6 3.9C15.6 1.6 13.2 0 10.4 0 4.7 0 0 4.7 0 10.4c0 9.4 16.1 18.6 16.1 18.6S32 19.8 32 10.4C32 4.7 27.3 0 23.6 0z'/%3E%3C/svg%3E");
      mask-repeat: no-repeat;
      mask-size: contain;
      mask-position: center;
    }
    .heart.hit{ --hs: 1.22; }
    @keyframes floatUp{0%{transform: translate(-50%,0) scale(1); opacity:1;} 100%{transform: translate(-50%,-320px) scale(1.08); opacity:0;}}

    /* heart-game score ping */
    .hgBar{margin-top:14px; padding:14px; border-radius:18px; border:1px solid rgba(0,0,0,0.06); background: rgba(255,255,255,0.72);
      display:flex; gap:12px; align-items:center; justify-content:space-between; flex-wrap:wrap;}
    .hgLeft{display:flex; gap:10px; align-items:baseline; flex-wrap:wrap;}
    .hgLabel{font-size:12px; color:rgba(0,0,0,0.55)}
    .hgValue{font-size:22px; font-weight:950; color:rgba(0,0,0,0.82)}
    .hgMeta{font-size:12px; color:rgba(0,0,0,0.45)}
    .hgBeat{display:inline-block; transform-origin:center;}
    .hgBeat.ping1{animation: beat1 260ms ease-out;}
    .hgBeat.ping5{animation: beat5 460ms cubic-bezier(.2,1.3,.2,1);}
    @keyframes beat1{0%{transform: scale(1);} 45%{transform: scale(1.16);} 100%{transform: scale(1);} }
    @keyframes beat5{0%{transform: scale(1);} 35%{transform: scale(1.38);} 70%{transform: scale(1.14);} 100%{transform: scale(1);} }
    .rewards{margin-top:16px;}
    .rewardsTitle{font-weight:900; color:rgba(0,0,0,0.78)}
    .grid{margin-top:10px; display:grid; grid-template-columns: repeat(3, minmax(0, 1fr)); gap:10px;}
    .reward{padding:14px; border-radius:18px; border:1px solid rgba(0,0,0,0.06); background: rgba(255,255,255,0.68)}
    .reward.ok{background: linear-gradient(135deg, rgba(255,205,226,0.55), rgba(200,233,255,0.55));}
    .rewardTop{display:flex; justify-content:space-between; gap:10px; align-items:baseline}
    .rewardName{font-weight:900; font-size:14px; color:rgba(0,0,0,0.78)}
    .rewardNeed{font-size:12px; color:rgba(0,0,0,0.55); white-space:nowrap}
    .rewardDesc{margin-top:8px; font-size:13px; color:rgba(0,0,0,0.60); line-height:1.6}
    .footer{margin-top:14px; font-size:12px; color:rgba(0,0,0,0.45); text-align:center}
    .toast{position:fixed; bottom:18px; left:50%; transform:translateX(-50%); padding:10px 14px; border-radius:999px;
      background: rgba(0,0,0,0.78); color:#fff; font-size:13px; box-shadow: 0 18px 50px rgba(0,0,0,0.20);
      max-width: calc(100% - 26px); text-align:center; display:none;}

    /* center message for perfect run */
    .centerMsg{position:fixed; inset:0; display:grid; place-items:center; padding:18px;
      background: rgba(255,255,255,0.35); backdrop-filter: blur(10px); z-index: 50;}
    .centerCard{width:min(560px, 100%); border-radius:22px; padding:18px 16px;
      background: rgba(255,255,255,0.86); border:1px solid rgba(0,0,0,0.06);
      box-shadow:0 24px 70px rgba(0,0,0,0.12);
      text-align:center; font-size:18px; line-height:1.8; color: rgba(0,0,0,0.78);
      background-image: radial-gradient(800px 240px at 30% 20%, rgba(255,205,226,0.55), transparent 60%),
                        radial-gradient(800px 240px at 75% 35%, rgba(200,233,255,0.55), transparent 60%);
    }
    .centerSub{display:block; margin-top:8px; font-size:14px; color: rgba(0,0,0,0.60);}
    .centerSign{display:block; margin-top:10px; font-size:13px; color: rgba(0,0,0,0.50);}

    /* burst effect */
    .spark{
      position:absolute;
      width:10px;
      height:10px;
      border-radius:999px;
      pointer-events:none;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.95), rgba(255,255,255,0.2) 35%, rgba(255,255,255,0) 70%),
                  linear-gradient(135deg, rgba(255,143,194,1), rgba(124,199,255,1));
      filter: drop-shadow(0 10px 14px rgba(0,0,0,0.12));
      transform: translate(-50%, -50%);
      animation: sparkOut 520ms ease-out forwards;
    }
    @keyframes sparkOut{
      0%{ opacity: 0; transform: translate(-50%, -50%) scale(0.6); }
      12%{ opacity: 1; }
      100%{ opacity: 0; transform: translate(calc(-50% + var(--dx)), calc(-50% + var(--dy))) scale(0.25); }
    }

    /* "very simple password gate" overlay */
    .gate{position:fixed; inset:0; display:grid; place-items:center; background: rgba(255,255,255,0.55); backdrop-filter: blur(10px);}
    .gateCard{width:min(520px, calc(100% - 32px)); border-radius:22px; background: rgba(255,255,255,0.88);
      border:1px solid rgba(0,0,0,0.06); box-shadow:0 24px 70px rgba(0,0,0,0.10); padding:22px;}
    .gateTitle{font-size:22px; font-weight:900; color:rgba(0,0,0,0.82)}
    .gateSub{margin-top:8px; font-size:13px; color:rgba(0,0,0,0.55); line-height:1.6}
    .label{display:block; margin-top:14px; font-size:12px; color:rgba(0,0,0,0.55)}
    .input{margin-top:6px; width:100%; border-radius:14px; border:1px solid rgba(0,0,0,0.10); padding:10px 12px; font-size:14px; outline:none; background: rgba(255,255,255,0.9);}
    .err{margin-top:12px; font-size:13px; color:#b0003a;}

    @media (max-width:760px){
      .grid{grid-template-columns:1fr;}
      .stats{grid-template-columns:1fr;}
      .title{font-size:26px;}
      .btns{flex-direction:column;}
      .btn{width:100%;}
    }
  </style>
</head>
<body>
  <div class="card" id="app" style="display:none">
    <div class="title">Theo 的小花园</div>
    <div class="sub">先来签到一下～然后再玩玩心心小游戏。</div>

    <div class="bubble">
      <div class="bubbleText" id="greet" style="display:none"></div>

      <div class="btns">
        <button class="btn primary" id="btnDaily">今天签到</button>
        <button class="btn" id="btnNew" style="display:none">换一句</button>
        <button class="btn" id="btnReset" style="display:none">重置数据（调试）</button>
      </div>

      <div class="calWrap">
        <div class="calHead">
          <button class="btn" id="cPrev">←</button>
          <div class="calTitle" id="cTitle"></div>
          <button class="btn" id="cNext">→</button>
        </div>
        <div class="calWeek" id="cWeek"></div>
        <div class="calGrid" id="cGrid"></div>
      </div>

      <div class="sign">- Evie</div>
    </div>

    <div class="stats">
      <div class="stat"><div class="statLabel">你的心心</div><div class="statValue" id="score">0</div></div>
      <div class="stat"><div class="statLabel">今日签到</div><div class="statValue" id="daily">未领取</div></div>
    </div>

    <div class="game">
      <div class="gameTitle">小游戏 1：收集小心心（点一下 +1）</div>
      <div class="gameDesc">每小时可玩 5 次。每击中一个 +1；如果这一局全部击中，额外 +5，并送你一句甜甜的提示。</div>

      <div class="hgBar">
        <div class="hgLeft">
          <div class="hgLabel">今日小心心积分</div>
          <div class="hgValue"><span class="hgBeat" id="hgPoints">0</span></div>
          <div class="hgMeta" id="hgMeta">本小时剩余 5 次</div>
        </div>
      </div>

      <div class="board" id="board"><div class="hint">点「开始收集心心」后，小心心会飘出来</div></div>
      <div class="btns" style="margin-top:12px">
        <button class="btn primary" id="btnStart2">开始收集心心</button>
      </div>

      <div style="height:12px"></div>

      <div class="gameTitle">小游戏 2：对准目标（长按充能）</div>
      <div class="gameDesc">同一个画面里会有“目标心心”和“你的心心”。按住按钮让你的小心心长大，松手时越接近目标大小，得分越高（0～9）。</div>
      <div class="board" id="chargeBoard">
        <div class="chargeStage">
          <div class="compareWrap">
            <div class="targetLabel">目标心心</div>
            <div class="targetHeart" id="targetHeart">
              <svg class="targetSvg" viewBox="0 0 32 29" aria-hidden="true">
                <path d="M23.6 0c-2.8 0-5.2 1.6-6.6 3.9C15.6 1.6 13.2 0 10.4 0 4.7 0 0 4.7 0 10.4c0 9.4 16.1 18.6 16.1 18.6S32 19.8 32 10.4C32 4.7 27.3 0 23.6 0z" fill="none" stroke="rgba(31,102,227,0.65)" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </div>
            <div class="yourLabel">你的心心</div>
            <div class="aimHeart" id="aimHeart"></div>
          </div>
        </div>
        <div class="hint" id="chargeHint">按住下面按钮开始充能，松手结算</div>
      </div>
      <div class="btns" style="margin-top:12px">
        <button class="btn primary" id="chargeBtn" aria-label="charge">按住充能 ❤</button>
      </div>
    </div>

    <div class="rewards">
      <div class="rewardsTitle">抽奖小机</div>
      <div class="btns" style="margin-top:10px">
        <button class="btn primary" id="drawBtn">抽一次（-10 心心）</button>
      </div>
      <div class="sub" style="margin-top:10px">抽到的券券会收进你的“小口袋”。</div>
      <div class="grid" id="rewards"></div>
    </div>

    <div class="footer">提示：分数与抽到的券券只保存在本设备本地（localStorage）。</div>
  </div>

  <div class="gate" id="gate" style="display:none">
    <div class="gateCard">
      <div class="gateTitle">Theo 的小站 · 登录</div>
      <div class="gateSub">这是一个很简单的"密码门"。输入对了就放你进来～</div>
      <label class="label">用户名</label>
      <input class="input" id="u" value="Theo" />
      <label class="label">密码</label>
      <input class="input" id="p" type="password" placeholder="请输入密码" />
      <div class="err" id="err" style="display:none"></div>
      <div class="btns" style="margin-top:14px">
        <button class="btn primary" id="btnEnter">进入小站</button>
      </div>
      <div class="footer">- Evie</div>
    </div>
  </div>

  <div class="toast" id="toast"></div>
  <div class="centerMsg" id="centerMsg" style="display:none">
    <div class="centerCard" id="centerCard"></div>
  </div>

  <script>
    // NOTE: This is a *simple* client-side gate (not real security).
    // It's meant for "friends-only" sharing and maximum compatibility.
    // We avoid keeping the username/password in plaintext.
    // This is *obfuscation*, not real security (a determined person can still brute-force).
    const EXPECT_USER_SHA256 = '8130fe9d5aa06f896c96f959030adf76e79b2caa46fc0f8593b14dfac97a9171';
    const EXPECT_PASS_SHA256 = '4e3cbbf1c5af8a09b60027b5f37c31535d582793380720ef1ef68454f35e1ef1';

    async function sha256Hex(text) {
      const enc = new TextEncoder().encode(text);
      const digest = await crypto.subtle.digest('SHA-256', enc);
      return Array.from(new Uint8Array(digest)).map(b => b.toString(16).padStart(2, '0')).join('');
    }

    const GREETINGS = [
      'Theo～今天也要被温柔对待哦。你一出现，我的世界就会自动变甜。',
      'Theo，给你一颗小星星：⭐ 代表"你很棒"。',
      'Theo～如果你累了，就把烦恼交给我 10 秒钟，我帮你抱着。',
      'Theo，今天的你像热可可：不吵不闹，但特别暖。',
      'Theo～我偷偷把好运调成"只对你生效"。',
      'Theo，来个可爱小笑话：我想严肃三秒…失败了，因为一想到你就想笑。',
      'Theo～你不需要一直发光，偶尔当一盏小夜灯也超棒。',
      'Theo，今天也请你对自己甜一点，像对待小朋友那样。',
      'Theo～如果今天心里下雨，我就当你的伞（带小花边那种）。',
      'Theo，抱抱券已送达：不限次数，不限时段。'
    ];

    const PRIZES = [
      { id: 'hug', title: '抱抱券', desc: '可兑换一个抱抱（不限时）' },
      { id: 'kiss', title: '亲亲券', desc: '可兑换一个亲亲（害羞也算）' },
      { id: 'coffee', title: '咖啡券', desc: '可兑换一杯咖啡/奶茶（想喝就喝）' },
      { id: 'walk', title: '散步券', desc: '可兑换一次散步（一起慢慢走）' },
    ];

    const DRAW_COST = 10;

    const $ = (id) => document.getElementById(id);
    const toast = (msg) => {
      const t = $('toast');
      t.textContent = msg;
      t.style.display = 'block';
      clearTimeout(toast._timer);
      toast._timer = setTimeout(() => t.style.display = 'none', 1800);
    };

    const hideCenterMsg = () => {
      const wrap = $('centerMsg');
      const card = $('centerCard');
      if (!wrap || !card) return;
      wrap.style.display = 'none';
      card.innerHTML = '';
    };

    const centerMsg = (html, opts = {}) => {
      const wrap = $('centerMsg');
      const card = $('centerCard');
      if (!wrap || !card) return;

      const { delayMs = 0, autoHideMs = null, buttonText = '我知道了(✋ˇ-ˇ)' } = opts;

      clearTimeout(centerMsg._timer);

      const show = () => {
        card.innerHTML = html +
          `<div style="margin-top:14px; display:flex; justify-content:center;">
             <button class="btn" id="centerOkBtn">${buttonText}</button>
           </div>`;
        wrap.style.display = 'grid';

        // bind close button
        setTimeout(() => {
          const b = document.getElementById('centerOkBtn');
          if (b) b.onclick = (e) => { e.preventDefault(); hideCenterMsg(); };
        }, 0);

        if (autoHideMs && autoHideMs > 0) {
          centerMsg._timer = setTimeout(hideCenterMsg, autoHideMs);
        }
      };

      if (delayMs && delayMs > 0) {
        centerMsg._timer = setTimeout(show, delayMs);
      } else {
        show();
      }
    };

    const todayKey = () => {
      const d = new Date();
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,'0');
      const day = String(d.getDate()).padStart(2,'0');
      return `${y}-${m}-${day}`;
    };

    const state = {
      score: 0,
      bag: {}, // prizeId -> count
      dailyBonusTaken: false,
    };

    const load = () => {
      try {
        state.score = Number(localStorage.getItem('theo_score') || '0') || 0;
        state.bag = JSON.parse(localStorage.getItem('theo_bag') || '{}') || {};
        state.dailyBonusTaken = (localStorage.getItem('theo_daily_bonus_day') === todayKey());
      } catch {}
    };

    const save = () => {
      try {
        localStorage.setItem('theo_score', String(state.score));
        localStorage.setItem('theo_bag', JSON.stringify(state.bag));
      } catch {}
    };

    const render = () => {
      $('score').textContent = String(state.score);
      $('daily').textContent = state.dailyBonusTaken ? '已领取' : '未领取';

      const grid = $('rewards');
      grid.innerHTML = '';

      const total = Object.values(state.bag || {}).reduce((a,b)=>a+(Number(b)||0), 0);
      if (!total) {
        const empty = document.createElement('div');
        empty.className = 'reward';
        empty.innerHTML = `
          <div class="rewardTop">
            <div class="rewardName">小口袋空空</div>
            <div class="rewardNeed">先抽一次吧～</div>
          </div>
          <div class="rewardDesc">每抽一次消耗 ${DRAW_COST} 心心。</div>
        `;
        grid.appendChild(empty);
        return;
      }

      for (const p of PRIZES) {
        const cnt = Number((state.bag || {})[p.id] || 0);
        if (!cnt) continue;
        const div = document.createElement('div');
        div.className = 'reward ok';
        div.innerHTML = `
          <div class="rewardTop">
            <div class="rewardName">${p.title}</div>
            <div class="rewardNeed">x ${cnt}</div>
          </div>
          <div class="rewardDesc">${p.desc}</div>
        `;
        grid.appendChild(div);
      }
    };

    const maybeUnlock = () => {};

    const pickGreeting = () => {
      const pick = GREETINGS[Math.floor(Math.random() * GREETINGS.length)];
      $('greet').textContent = pick;
    };

    // avoid overlapping too much by spacing X positions
    const activeHeartXs = []; // { id, x }
    const blueColors = [
      '#061a5f', // deep navy
      '#0b2a78',
      '#1442a6',
      '#1f66e3',
      '#4d9bff',
      '#a7dbff', // light blue
    ];

    // Heart-game daily points + hourly play limit
    const hgPointsEl = () => $('hgPoints');
    const hgMetaEl = () => $('hgMeta');

    const hgDayKey = () => `${todayKey()}_heartgame_points`;
    const hgPlaysKey = () => 'theo_heartgame_plays'; // array of timestamps

    const getHgPoints = () => {
      try { return Number(localStorage.getItem(hgDayKey()) || '0') || 0; } catch { return 0; }
    };
    const setHgPoints = (v) => {
      try { localStorage.setItem(hgDayKey(), String(v)); } catch {}
    };

    const getRecentPlays = () => {
      const now = Date.now();
      try {
        const arr = JSON.parse(localStorage.getItem(hgPlaysKey()) || '[]');
        const cleaned = Array.isArray(arr) ? arr.filter(t => typeof t === 'number' && now - t < 60*60*1000) : [];
        localStorage.setItem(hgPlaysKey(), JSON.stringify(cleaned));
        return cleaned;
      } catch {
        return [];
      }
    };

    const remainingPlays = () => {
      const used = getRecentPlays().length;
      return Math.max(0, 5 - used);
    };

    const recordPlay = () => {
      const arr = getRecentPlays();
      arr.push(Date.now());
      try { localStorage.setItem(hgPlaysKey(), JSON.stringify(arr)); } catch {}
    };

    const pingHg = (kind /* 1|5 */) => {
      const el = hgPointsEl();
      if (!el) return;
      el.classList.remove('ping1','ping5');
      // force reflow
      void el.offsetWidth;
      el.classList.add(kind === 5 ? 'ping5' : 'ping1');
    };

    const renderHg = () => {
      const pts = getHgPoints();
      if (hgPointsEl()) hgPointsEl().textContent = String(pts);
      if (hgMetaEl()) hgMetaEl().textContent = `本小时剩余 ${remainingPlays()} 次`;
    };

    // Charge-game hourly play limit (game 2)
    const chargePlaysKey = () => 'theo_charge_plays';
    const getRecentChargePlays = () => {
      const now = Date.now();
      try {
        const arr = JSON.parse(localStorage.getItem(chargePlaysKey()) || '[]');
        const cleaned = Array.isArray(arr) ? arr.filter(t => typeof t === 'number' && now - t < 60*60*1000) : [];
        localStorage.setItem(chargePlaysKey(), JSON.stringify(cleaned));
        return cleaned;
      } catch {
        return [];
      }
    };
    const remainingChargePlays = () => {
      const used = getRecentChargePlays().length;
      return Math.max(0, 5 - used);
    };
    const recordChargePlay = () => {
      const arr = getRecentChargePlays();
      arr.push(Date.now());
      try { localStorage.setItem(chargePlaysKey(), JSON.stringify(arr)); } catch {}
    };

    const pickX = () => {
      const minDist = 12; // percentage points
      for (let tries = 0; tries < 24; tries++) {
        const x = Math.random() * 90 + 5;
        const ok = activeHeartXs.every(h => Math.abs(h.x - x) >= minDist);
        if (ok) return x;
      }
      return Math.random() * 90 + 5;
    };

    // current heart-game run state
    let hgRun = null; // { total, remaining, missed }

    const spawnHeart = () => {
      const board = $('board');
      const heart = document.createElement('button');
      heart.className = 'heart';
      heart.type = 'button';
      heart.setAttribute('aria-label', 'heart');

      const x = pickX();
      const dur = 1900 + Math.random() * 1300; // faster float
      heart.style.left = `${x}%`;
      heart.style.animationDuration = `${dur}ms`;
      heart.style.setProperty('--hc', blueColors[Math.floor(Math.random() * blueColors.length)]);

      const id = Math.random().toString(36).slice(2);
      heart.dataset.hid = id;
      activeHeartXs.push({ id, x });

      // Prevent iOS double-tap zoom / selection quirks
      heart.addEventListener('touchstart', (e) => { e.preventDefault(); }, { passive: false });

      const burst = (el) => {
        const boardRect = board.getBoundingClientRect();
        const r = el.getBoundingClientRect();
        const cx = r.left - boardRect.left + r.width / 2;
        const cy = r.top - boardRect.top + r.height / 2;

        const hc = el.style.getPropertyValue('--hc') || '#ff5aa8';

        // sparks
        const n = 10;
        for (let i = 0; i < n; i++) {
          const s = document.createElement('div');
          s.className = 'spark';
          s.style.left = `${cx}px`;
          s.style.top = `${cy}px`;
          s.style.background = `radial-gradient(circle at 30% 30%, rgba(255,255,255,0.95), rgba(255,255,255,0.2) 35%, rgba(255,255,255,0) 70%), linear-gradient(135deg, ${hc}, rgba(124,199,255,1))`;
          const ang = (Math.PI * 2 * i) / n + (Math.random() * 0.25);
          const dist = 44 + Math.random() * 20;
          const dx = Math.cos(ang) * dist;
          const dy = Math.sin(ang) * dist;
          s.style.setProperty('--dx', `${dx}px`);
          s.style.setProperty('--dy', `${dy}px`);
          s.style.animationDelay = `${Math.random() * 40}ms`;
          board.appendChild(s);
          setTimeout(() => s.remove(), 700);
        }
      };

      const removeFromActive = () => {
        const idx = activeHeartXs.findIndex(h => h.id === heart.dataset.hid);
        if (idx >= 0) activeHeartXs.splice(idx, 1);
      };

      let done = false;
      const hit = () => {
        if (done) return;
        done = true;
        heart.classList.add('hit');
        burst(heart);

        // +1
        state.score += 1;
        const pts = getHgPoints() + 1;
        setHgPoints(pts);
        pingHg(1);
        renderHg();

        maybeUnlock();
        save();
        render();
        toast('+1 心心');

        if (hgRun) {
          hgRun.remaining -= 1;
          if (hgRun.remaining <= 0) {
            // run finished
            if (!hgRun.missed) {
              // perfect bonus
              state.score += 5;
              setHgPoints(getHgPoints() + 5);
              pingHg(5);
              renderHg();
              maybeUnlock();
              save();
              render();
              centerMsg(
                `Theo 超棒，10 个小心心全部击中，额外加 5 分～(╹◡╹)～` +
                `<span class="centerSign">- Evie</span>`,
                { delayMs: 200, autoHideMs: null, buttonText: '我知道了(✋ˇ-ˇ)' }
              );
            }
            hgRun = null;
          }
        }

        setTimeout(() => { removeFromActive(); heart.remove(); }, 140);
      };

      // Use pointerdown for better mobile responsiveness
      heart.addEventListener('pointerdown', (e) => {
        e.preventDefault();
        hit();
      });
      heart.addEventListener('click', (e) => {
        e.preventDefault();
        hit();
      });

      board.appendChild(heart);
      setTimeout(() => { if (heart.isConnected) {
        // missed this heart
        if (hgRun) {
          hgRun.missed = true;
          hgRun.remaining -= 1;
          if (hgRun.remaining <= 0) hgRun = null;
        }

        const idx = activeHeartXs.findIndex(h => h.id === heart.dataset.hid);
        if (idx >= 0) activeHeartXs.splice(idx, 1);
        heart.remove();
      } }, dur + 200);
    };

    const startMiniGame = () => {
      const left = remainingPlays();
      renderHg();
      if (left <= 0) {
        toast('Theo～这一小时已经玩满 5 次啦，休息一下，下一小时再来 ❤ - Evie');
        return;
      }

      recordPlay();
      renderHg();

      toast('开始收集心心～点小心心加分！');
      const count = 10; // one run hearts
      hgRun = { total: count, remaining: count, missed: false };
      for (let i=0;i<count;i++) setTimeout(spawnHeart, i*220);
    };

    // check-in calendar (local only)
    const CHECKIN_STORE = 'theo_garden_checkins_v1';
    let cViewY = 0;
    let cViewM = 0;
    let checkins = new Set();

    const ymd = (d) => {
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,'0');
      const dd = String(d.getDate()).padStart(2,'0');
      return `${y}-${m}-${dd}`;
    };
    const loadCheckins = () => {
      try {
        const arr = JSON.parse(localStorage.getItem(CHECKIN_STORE) || '[]');
        checkins = new Set(Array.isArray(arr) ? arr : []);
      } catch {
        checkins = new Set();
      }
    };
    const saveCheckins = () => {
      try { localStorage.setItem(CHECKIN_STORE, JSON.stringify(Array.from(checkins).sort())); } catch {}
    };
    const renderCWeek = () => {
      const w = $('cWeek');
      if (!w) return;
      w.innerHTML = '';
      for (const n of ['一','二','三','四','五','六','日']){
        const d = document.createElement('div');
        d.textContent = n;
        w.appendChild(d);
      }
    };
    const renderCheckinCalendar = () => {
      const title = $('cTitle');
      const grid = $('cGrid');
      if (!title || !grid) return;
      title.textContent = `${cViewY} / ${String(cViewM).padStart(2,'0')}`;
      grid.innerHTML = '';

      const first = new Date(cViewY, cViewM-1, 1);
      const startDow = (first.getDay() + 6) % 7;
      const daysInMonth = new Date(cViewY, cViewM, 0).getDate();

      for (let i=0;i<startDow;i++) {
        const d = document.createElement('div');
        d.className = 'calCell dim';
        grid.appendChild(d);
      }

      for (let day=1; day<=daysInMonth; day++) {
        const dayStr = `${cViewY}-${String(cViewM).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
        const signed = checkins.has(dayStr);
        const cell = document.createElement('div');
        cell.className = 'calCell' + (signed ? ' signed' : '');
        cell.innerHTML = `<div class="calNum">${day}</div>` + (signed ? `<div class="calDot"></div>` : '');
        grid.appendChild(cell);
      }
    };

    const dailyBonus = () => {
      if (state.dailyBonusTaken) return toast('今天已经签过到啦～');
      state.score += 7;
      state.dailyBonusTaken = true;
      try { localStorage.setItem('theo_daily_bonus_day', todayKey()); } catch {}

      // mark calendar
      checkins.add(ymd(new Date()));
      saveCheckins();
      renderCheckinCalendar();

      maybeUnlock();
      save();
      render();
      toast('签到成功：+7 心心！');
    };

    const resetAll = () => {
      if (!confirm('要重置所有本地数据吗？（登录态/积分/次数/贴纸都会清空，仅当前设备）')) return;
      state.score = 0;
      state.unlocked = {};
      state.dailyBonusTaken = false;
      hgRun = null;
      activeHeartXs.splice(0, activeHeartXs.length);
      try {
        localStorage.removeItem('theo_gate_ok');
        localStorage.removeItem('theo_score');
        localStorage.removeItem('theo_bag');
        localStorage.removeItem('theo_daily_bonus_day');
        localStorage.removeItem('theo_heartgame_plays');
        localStorage.removeItem(`${todayKey()}_heartgame_points`);
      } catch {}
      render();
      renderHg();
      toast('已重置～');
      // optional: reload to ensure clean UI state
      setTimeout(() => location.reload(), 300);
    };

    // gate
    const showApp = () => {
      $('gate').style.display = 'none';
      $('app').style.display = 'block';
      load();

      // init check-in calendar
      loadCheckins();
      const now = new Date();
      cViewY = now.getFullYear();
      cViewM = now.getMonth() + 1;
      renderCWeek();
      renderCheckinCalendar();
      $('cPrev') && ($('cPrev').onclick = () => { cViewM -= 1; if (cViewM <= 0) { cViewM = 12; cViewY -= 1; } renderCheckinCalendar(); });
      $('cNext') && ($('cNext').onclick = () => { cViewM += 1; if (cViewM >= 13) { cViewM = 1; cViewY += 1; } renderCheckinCalendar(); });

      // no greeting at top (keep function but hide UI)
      pickGreeting();
      maybeUnlock();
      render();
      renderHg();

      $('btnNew') && ($('btnNew').onclick = pickGreeting);
      $('btnStart2').onclick = startMiniGame;
      $('btnDaily').onclick = dailyBonus;
      $('btnReset') && ($('btnReset').onclick = resetAll);
      $('drawBtn') && ($('drawBtn').onclick = () => {
        if (state.score < DRAW_COST) {
          toast(`心心不够啦～需要 ${DRAW_COST} 心心`);
          return;
        }
        state.score -= DRAW_COST;
        const p = PRIZES[Math.floor(Math.random() * PRIZES.length)];
        state.bag[p.id] = (Number(state.bag[p.id] || 0) + 1);
        save();
        render();
        centerMsg(`抽到了：<b>${p.title}</b> ✨<span class="centerSub">${p.desc}</span>`, { buttonText: '收进小口袋(๑•̀ㅂ•́)و' });
      });

      // refresh remaining plays every ~10s (hour window)
      setInterval(renderHg, 10000);

      // Mini game 2: match the target heart size by charging a heart (0..9)
      const chargeBtn = $('chargeBtn');
      const chargeHint = $('chargeHint');
      const targetHeart = $('targetHeart');
      const aimHeart = $('aimHeart');

      let charging = false;
      let raf = null;
      let startAt = 0;
      let targetScale = 1.0;
      let starScale = 1.0;

      // With larger base heart, keep scales in a comfy visible range.
      const MIN_TARGET = 0.70;
      const MAX_TARGET = 1.35;
      const MIN_STAR = 0.10;   // start very small from the center
      const MAX_STAR = 1.85;   // can grow bigger than the target
      const CHARGE_MS = 1550; // time to reach max

      const setTarget = () => {
        targetScale = MIN_TARGET + Math.random() * (MAX_TARGET - MIN_TARGET);
        if (targetHeart) {
          targetHeart.style.setProperty('--ts', String(targetScale));
        }
      };

      const setHeart = (s) => {
        starScale = Math.max(MIN_STAR, Math.min(MAX_STAR, s));
        if (aimHeart) aimHeart.style.setProperty('--ss', String(starScale));
      };

      const renderChargeHint = (extra = '') => {
        if (!chargeHint) return;
        const left = remainingChargePlays();
        chargeHint.textContent = charging
          ? '充能中…松手结算（0～9 分）'
          : (extra || `按住开始充能，松手结算（0～9 分） · 本小时剩余 ${left} 次`);
      };

      const scoreByCloseness = (s, t) => {
        const rel = Math.abs(s - t) / t; // 0 is perfect
        // map to 0..9 (smaller rel => higher score)
        const sc = Math.round(9 - rel * 18);
        return Math.max(0, Math.min(9, sc));
      };

      const stopCharge = () => {
        if (!charging) return;
        charging = false;
        if (raf) cancelAnimationFrame(raf);
        raf = null;

        // consume one play
        recordChargePlay();

        const gained = scoreByCloseness(starScale, targetScale);
        state.score += gained;
        maybeUnlock();
        save();
        render();

        const msg =
          gained >= 9 ? '完美命中！你也太会了吧 ✨ +9 心心' :
          gained >= 7 ? `好准！+${gained} 心心` :
          gained >= 5 ? `不错不错～ +${gained} 心心` :
          gained >= 3 ? `差一点点更像啦～ +${gained} 心心` :
          gained >= 1 ? `没关系，再来一次就更准～ +${gained} 心心` :
          '这次没对上也没事～抱抱，再试试';

        toast(msg);
        renderChargeHint(`本次得分：${gained} · 本小时剩余 ${remainingChargePlays()} 次`);

        // next round
        setTimeout(() => {
          setTarget();
          setHeart(MIN_STAR);
        }, 180);
      };

      const tick = (now) => {
        const p = Math.min(1, (now - startAt) / CHARGE_MS);
        // smooth-ish curve
        const eased = 1 - Math.pow(1 - p, 2.2);
        setHeart(MIN_STAR + (MAX_STAR - MIN_STAR) * eased);
        if (charging && p < 1) raf = requestAnimationFrame(tick);
        if (charging && p >= 1) {
          // auto stop at full charge (forces a score if held too long)
          stopCharge();
        }
      };

      const startCharge = () => {
        if (remainingChargePlays() <= 0) {
          toast('这一小时已经玩满 5 次啦～等一会再来');
          renderChargeHint();
          return;
        }
        charging = true;
        startAt = performance.now();
        renderChargeHint();
        if (raf) cancelAnimationFrame(raf);
        raf = requestAnimationFrame(tick);
      };

      // Pointer events for mobile
      chargeBtn.addEventListener('pointerdown', (e) => {
        e.preventDefault();
        if (charging) return;
        chargeBtn.setPointerCapture?.(e.pointerId);
        startCharge();
      });
      chargeBtn.addEventListener('pointerup', (e) => { e.preventDefault(); stopCharge(); });
      chargeBtn.addEventListener('pointercancel', (e) => { e.preventDefault(); stopCharge(); });

      // Also prevent iOS double-tap zoom on this control
      chargeBtn.addEventListener('touchstart', (e) => { e.preventDefault(); }, { passive: false });

      // init
      setTarget();
      setHeart(MIN_STAR);
      renderChargeHint();
    };

    const showGate = () => {
      $('app').style.display = 'none';
      $('gate').style.display = 'grid';
      $('btnEnter').onclick = async () => {
        const u = $('u').value.trim();
        const p = $('p').value;
        try {
          const [uh, ph] = await Promise.all([sha256Hex(u), sha256Hex(p)]);
          if (uh === EXPECT_USER_SHA256 && ph === EXPECT_PASS_SHA256) {
            try { localStorage.setItem('theo_gate_ok', '1'); } catch {}
            showApp();
            return;
          }
        } catch {}

        $('err').style.display = 'block';
        $('err').textContent = '用户名或密码不对哦～';
      };
    };

    // init
    try {
      const ok = localStorage.getItem('theo_gate_ok') === '1';
      ok ? showApp() : showGate();
    } catch {
      showGate();
    }
  </script>
</body>
</html>
